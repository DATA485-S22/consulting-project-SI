---
title: "CEM Results"
author: "Skip Moses"
date: "4/3/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Joseph Shifman's exploring file
library(tidyverse)
library(readxl)
library(magrittr) # Allows %<>% notation to update lhs object with resulting value
library(naniar)
library(Hmisc) # %nin%
library(ggplot2)
library(MatchIt)
library(lmtest)
library(sandwich)
```

## Summary

This is a document for Coarsened Exact Mathcing results.

## BIO104

```{r}
data <- read.csv("data/CEM_dataset.csv")
```

```{r}
summary(factor(data$SI.Attended))
```


```{r}
matching <- matchit(SI.Attended ~ 
                      HS.GPA + 
                      Student.Orientation.Flag +
                      Major.1.STEM.Flag +
                      Full.Time.Part.Time.Code +
                      Academic.Program,
                    data = data, method = 'cem', estimand = 'ATE')
summary(matching)

# Extract Matchings

matched_df1 <- match.data(matching) %>% arrange(subclass, SI.Attended)

# Estimate Causal Impact

matched_df1 %>% ggplot(aes(factor(SI.Attended), Student.Class.Grade.Point.per.Unit)) + geom_boxplot()

matched_df1 %>% group_by(SI.Attended) %>% summarise(mean = mean(Student.Class.Grade.Point.per.Unit))

model1 <- lm(Student.Class.Grade.Point.per.Unit ~ SI.Attended +
                                                  Gender.Code +
                                                  First.Generation.Flag +
                                                  Writing.Course.Flag +
                                                  Honors.Class.Flag, data = matched_df1,
             weights = weights)
coeftest(model1, vcov. = vcovCL,
         cluster = ~subclass)

```


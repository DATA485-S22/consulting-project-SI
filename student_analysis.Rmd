---
title: 'Student Level Analysis: SI on One Year Retention'
author: "Faith Fatchen"
date: "4/22/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(tidyverse)
library(readxl)
library(magrittr) #Allows %<>% notation to update lhs object with resulting value
library(naniar)
library(Hmisc) # %nin%
library(stargazer)
library(tinytex)
library(ggplot2)

courses<-read_csv("data/Course Detail.csv")
names(courses) <- make.names(names(courses), unique=TRUE)
courses <- courses %>%
  mutate(course_num_clean = str_extract(Course.Catalog.Number, "\\d+"))
courses$course_num_clean <- factor(courses$course_num_clean)
levels(courses$course_num_clean)

courses <- courses %>%
  filter(course_num_clean %nin% c(189, 289, 389, 489, 589, 689, #internship
                                  198, 298, 398, 498, 598, 698, #special topics
                                  199, 299, 399, 499, 599, #special problems
                                  696, 697, 699)) #independent study
courses$course_num_clean <- droplevels(courses$course_num_clean)

courses <- courses %>%
  filter(Term.Year >= 2016) # Start of SI


identical(courses[["Writing.Course.Flag.Description"]], courses[["Writing.or.Not.Writing.Class"]]) # TRUE
identical(courses[["GE.or.Program.Flag.Description"]], courses[["GE.or.Program.Major"]]) # TRUE

si_appt  <- read.csv("data/SLC Appointment.csv") %>% 
  select(-c(College.Year, Academic.Year, Term, Term.Type))
si_appt<- filter(si_appt, Term.Year>=2016)
  
courses$Random.Course.ID <- factor(courses$Random.Course.ID)
si_appt$Random.Course.ID <- factor(si_appt$Random.Course.ID)
si_appt$Random.Student.ID <- factor(si_appt$Random.Student.ID)

# Stores classes with an SI component
si_courses <- filter(courses, Random.Course.ID %in% levels(si_appt$Random.Course.ID))
#Joining SI Classes with SI visit data 
si_attend<-left_join(si_appt, si_courses, by = "Random.Course.ID")

profile <- read.csv("data/Student Profile Metric.csv") 

profile<- profile %>%  filter(Cohort.Term.Year >= 2016, 	
        Cohort.Student.Enrollment.Type == "First-Time Freshman") %>%
        select(-c(Transfer.GPA,Transfer.GPA.Group, Transfer.GPA.Group.Code))
profile$Cohort.Academic.Year = factor(profile$Cohort.Academic.Year)
profile$Years.enrolled = rowSums(profile[,c(24,25,26,27,28)]) 
profile$Years.enrolled = factor(profile$Years.enrolled )
profile$Random.Student.ID<-factor(profile$Random.Student.ID)

program<-read.csv("data/Student Program.csv") 
program<- filter(program, Term.Year >= 2016) %>%
  mutate(Term.Type = factor(Term.Type), .keep = "unused") %>%
  filter(Term.Type %nin% c("Summer", "Winter")) %>%
  select(Term, Random.Student.ID, Gender.Code, IPEDS.Ethnicity,
         IPEDS.Ethnicity.URM.Non.URM, First.Generation.Flag, Academic.Level,
         Academic.Program, Major.1.STEM.Flag, Major.1.College,
         Major.2.STEM.Flag, Major.2.College, Entry.Enrollment.Type,
         Academic.Standing.Status)

program$Random.Student.ID <- factor(program$Random.Student.ID)

d<-left_join(profile, si_attend, by = "Random.Student.ID" ) %>% 
  select(c(Random.Student.ID, Random.Course.ID),everything() )

d<-left_join(d, program, by = "Random.Student.ID")

d$SLC.Attended.Flag<-ifelse(is.na(d$SLC.Attended.Flag),0,1)
d$SLC.Attended.Flag<-factor(d$SLC.Attended.Flag)
d$Instruction.Mode<-factor(d$Instruction.Mode)
d$Student.Orientation.Flag<-factor(d$Student.Orientation.Flag)
d$GE.Class.Flag<-factor(d$GE.Class.Flag)
d$One.Year.Retention<-factor(d$One.Year.Retention)
d$URM<-factor(d$IPEDS.Ethnicity.URM.Non.URM)
d$Gender.Code<-factor(d$Gender.Code)
d$Writing.Course.Flag<-factor(d$Writing.Course.Flag) # no writing classes only one level so omitted from model
d$Major.1.STEM.Flag<-factor(d$Major.1.STEM.Flag)
d$Random.Instructor.ID<-factor(d$Random.Instructor.ID)
d$Class.Level<-factor(d$Class.Level)
d$Academic.Standing.Status<-factor(d$Academic.Standing.Status)
d$Cohort.Term.Year<-factor(d$Cohort.Term.Year)
d$First.Generation.Flag<-factor(d$First.Generation.Flag)
d$Term.Year<-factor(d$Term.Year.x)

d<-select(d, c(Random.Student.ID, Random.Course.ID, Cohort.Term.Year, Term.Year, Degree.Term, HS.GPA, One.Year.Retention,Student.Orientation.Flag, Years.enrolled, SLC.Attended.Flag, Random.Instructor.ID, Class.Level, Instruction.Mode, Writing.Course.Flag,GE.Class.Flag, Gender.Code, IPEDS.Ethnicity, IPEDS.Ethnicity.URM.Non.URM, URM, First.Generation.Flag, Major.1.STEM.Flag, Major.1.College, Academic.Standing.Status)) 

```


## Initial Model

```{r}
fit1<-glm(One.Year.Retention ~ SLC.Attended.Flag + Cohort.Term.Year + Student.Orientation.Flag + URM + First.Generation.Flag + Gender.Code + HS.GPA + Major.1.College + Major.1.STEM.Flag , family = binomial(link = "logit"), data = d)
summary(fit1)
```

```{r results='asis'}
#stargazer(fit1)
```
Notably,
- SLC positive & significant 
- Cohort yrs 2019 (fire), 2020 (Pandemic), (2021) negative & significant 
- First gen & URM positive & insignificant (bias?)
## With some interactions

```{r}
fit2<-glm(One.Year.Retention ~ SLC.Attended.Flag + Cohort.Term.Year + URM*First.Generation.Flag + Gender.Code + HS.GPA + Major.1.College + Major.1.STEM.Flag , family = binomial(link = "logit"), data = d)
summary(fit2)
```

```{r results='asis'}
#stargazer(fit2)
```
- with interaction URM negative & significant, First gen negative and significant, URM*First gen positive and signficant 

```{r}
fit3<-glm(One.Year.Retention ~ SLC.Attended.Flag + Cohort.Term.Year + URM + First.Generation.Flag + URM:First.Generation.Flag + URM:SLC.Attended.Flag + First.Generation.Flag:SLC.Attended.Flag +Gender.Code + HS.GPA + Major.1.College + Major.1.STEM.Flag , family = binomial(link = "logit"), data = d)
summary(fit3)
```

```{r results='asis'}
#stargazer(fit3)
```

- SLC non URM positive significant 
- SLC * URM positive significant
- SLC * First gen positive significant 

```{r results = "asis"}
#stargazer(fit1, fit2, fit3, header = FALSE)
```

